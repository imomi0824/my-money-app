<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OMI è¨˜å¸³æœ¬</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#228be6">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        :root {
            --bg-color: #f5f7fa; --card-bg: #ffffff; --primary-color: #228be6;
            --success-color: #40c057; --danger-color: #fa5252; --text-primary: #333; --border-color: #e0e0e0;
            --asset-yellow: #fcc419; --liab-purple: #9c36b5; --net-red: #fa5252;
            --transfer-color: #15aabf;
        }
        /* ç¦æ­¢é¸å–èˆ‡å½ˆæ€§æ²å‹• (Appè³ªæ„Ÿ) */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; 
            background-color: var(--bg-color); color: var(--text-primary); 
            margin: 0; padding: 20px; 
            -webkit-user-select: none; user-select: none;
            overscroll-behavior-y: none;
        }
        .container { max-width: 900px; margin: 0 auto; padding-bottom: 80px; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 10px; }
        .app-title { margin: 0; font-size: 24px; font-weight: 800; color: #333; letter-spacing: -0.5px; }
        .mode-btn { background: #fff; border: 1px solid #ddd; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .mode-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); box-shadow: 0 2px 5px rgba(34, 139, 230, 0.3); }
        .card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .hidden { display: none !important; }

        /* === Modal (å…±ç”¨) === */
        .modal-overlay { 
            display: none; position: fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.5); z-index: 10000; 
            justify-content:center; align-items:center; 
        }
        .modal-overlay.active { display: flex; }

        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 95%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); animation: popIn 0.2s ease-out; display: flex; flex-direction: column; max-height: 80vh; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; flex-shrink: 0; }
        .close-modal-btn { cursor: pointer; font-size: 20px; color: #999; padding: 0 5px; }
        .modal-body { overflow-y: auto; margin-bottom: 15px; flex-grow: 1; padding-right: 5px; }
        
        /* å­å¸³æˆ¶ç·¨è¼¯åˆ— */
        .sub-edit-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 6px; border: 1px solid #eee; transition: box-shadow 0.2s; }
        .sub-edit-item.dragging { opacity: 0.5; background: #e7f5ff; }
        .drag-handle { cursor: grab; color: #adb5bd; padding: 0 5px; font-size: 18px; user-select: none; }
        .sub-edit-item input[type="text"] { flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 4px; height: 36px; font-size: 14px; }
        .sub-edit-item input[type="number"] { flex: 1.5; padding: 8px; border: 1px solid #ddd; border-radius: 4px; height: 36px; font-size: 14px; }
        .del-sub-btn { color: #fa5252; background: none; border: none; font-size: 18px; cursor: pointer; padding: 0 5px; }
        .add-row-btn { width: 100%; padding: 8px; background: #e7f5ff; color: var(--primary-color); border: 1px dashed var(--primary-color); border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 5px; }
        .add-row-btn:hover { background: #d0ebff; }
        
        /* === è³‡ç”¢é é¢ === */
        .summary-bar { display: flex; border-radius: 12px; overflow: hidden; margin-bottom: 24px; color: white; text-align: center; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .summary-item { padding: 20px 10px; flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .summary-label { font-size: 13px; opacity: 0.9; margin-bottom: 5px; font-weight: normal; }
        .summary-val { font-size: 20px; font-family: 'SF Mono', monospace; letter-spacing: 0.5px; }
        .balance-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .balance-card { border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); background: #fff; border-top: 6px solid #ccc; transition: transform 0.2s; position: relative; }
        .balance-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .balance-header { padding: 15px 20px; font-weight: bold; font-size: 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f3f5; }
        .balance-val { font-family: 'SF Mono', monospace; font-size: 18px; }
        
        /* è³‡ç”¢å¡ç‰‡æŒ‰éˆ•ç¾¤ */
        .card-actions { display: flex; border-top: 1px solid #eee; }
        .card-action-btn { flex: 1; border: none; background: #fff; color: #555; padding: 10px; cursor: pointer; font-size: 12px; font-weight: 600; transition: background 0.2s; }
        .card-action-btn:hover { background: #f8f9fa; color: var(--primary-color); }
        .card-action-btn:first-child { border-right: 1px solid #eee; }

        .sub-account-list { list-style: none; padding: 0; margin: 0; background: #fafafa; }
        .sub-account-item { padding: 8px 20px; font-size: 13px; color: #555; border-bottom: 1px dashed #eee; }
        .sub-account-item.unallocated { background: #fffbe6; color: #d68e00; font-weight: bold; border-bottom: none; display:flex; justify-content:space-between; }
        .sub-row-main { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .sub-progress-bg { height: 4px; background: #eee; border-radius: 2px; width: 100%; overflow: hidden; }
        .sub-progress-fill { height: 100%; background: var(--primary-color); }
        .sub-info { font-size: 11px; color: #999; display: flex; justify-content: space-between; }
        .manage-sub-btn { width: 100%; border: none; background: #fff; color: var(--primary-color); padding: 8px; cursor: pointer; font-size: 12px; font-weight: 600; border-top: 1px solid #eee; transition: background 0.2s; }
        .manage-sub-btn:hover { background: #f1f3f5; }

        /* === çµ±è¨ˆ/æµæ°´å¸³/è¨­å®š === */
        .stat-mode-switch { display: flex; justify-content: center; margin-bottom: 15px; gap: 10px; }
        .mode-switch-btn { padding: 6px 16px; border: 1px solid #ddd; background: #f8f9fa; border-radius: 20px; cursor: pointer; font-size: 14px; color: #666; transition: all 0.2s; }
        .mode-switch-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); font-weight: bold; }
        .month-selector { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px; font-size: 18px; font-weight: bold; color: #333; }
        .month-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--primary-color); padding: 5px 15px; border-radius: 50%; transition: background 0.2s; }
        .stats-summary { display: flex; gap: 12px; margin-bottom: 20px; }
        .stats-box { flex: 1; padding: 16px; border-radius: 10px; text-align: center; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .stats-tabs { display: flex; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        .stats-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; color: #999; border-bottom: 3px solid transparent; font-weight: 600; transition: all 0.2s; }
        .stats-tab:hover { background-color: #f8f9fa; }
        .stats-tab.exp.active { color: var(--danger-color); border-bottom-color: var(--danger-color); }
        .stats-tab.inc.active { color: var(--success-color); border-bottom-color: var(--success-color); }
        .cat-stats-item { margin-bottom: 12px; cursor: pointer; border: 1px solid transparent; border-radius: 8px; padding: 10px 12px; transition: background 0.2s; }
        .cat-stats-item:hover { background: #f8f9fa; border-color: #eee; }
        .cat-row { display: flex; justify-content: space-between; align-items: center; font-size: 15px; }
        .cat-bar-bg { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; width: 100%; margin-top:8px; }
        .cat-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease-out; }
        .cat-details { display: none; margin-top: 12px; padding-top: 10px; border-top: 1px dashed #eee; font-size: 13px; color: #666; }
        .cat-stats-item.open .cat-details { display: block; animation: fadeIn 0.3s; }
        
        .input-grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
        @media (min-width: 600px) { .input-grid { grid-template-columns: repeat(12, 1fr); align-items: end; }
            .col-date, .col-acc, .col-to-acc, .col-type { grid-column: span 4; } 
            .col-sub-acc { grid-column: span 4; } 
            .col-amt, .col-cat { grid-column: span 6; } 
            .col-desc, .col-btn { grid-column: span 12; } 
        }
        select, input { padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; width: 100%; box-sizing: border-box; height: 42px; font-size: 15px; background: #fff; }
        button.action-btn { background-color: var(--primary-color); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; font-size: 16px; transition: background 0.2s; }
        button.action-btn:hover { background-color: #1c7ed6; }
        button.action-btn.update-mode { background-color: var(--success-color); }
        button.action-btn.cancel-mode { background-color: #868e96; margin-top: 10px; } 
        .transfer-mode-btn { background-color: var(--transfer-color) !important; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; white-space: nowrap; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #f1f3f5; color: #868e96; font-size: 13px; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid #f1f3f5; vertical-align: middle; }
        .tag { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; display: inline-block; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .icon-btn { border: none; background: none; cursor: pointer; font-size: 18px; padding: 4px 8px; border-radius: 4px; transition: background 0.2s; }
        .edit-btn { color: var(--primary-color); } .del-btn { color: var(--danger-color); }
        .sort-btn { font-size: 12px; padding: 2px 6px; margin-left: 5px; background: #e9ecef; border-radius: 4px; border:none; cursor: pointer; color: #666; }
        
        .color-picker-group { display: flex; gap: 10px; align-items: center; }
        .sortable-list { list-style: none; padding: 0; margin: 0; }
        .sortable-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #eee; margin-bottom: 8px; border-radius: 8px; background: #fff; transition: box-shadow 0.2s; }
        .sortable-item:hover { box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .color-dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; border: 2px solid #fff; box-shadow: 0 0 0 1px #ccc; }
        .edit-input-group { display: flex; gap: 5px; flex-grow: 1; }
        .save-btn { background: var(--success-color); color: white; border: none; border-radius: 4px; padding: 0 12px; cursor: pointer; }
        .csv-box { border: 2px dashed #a5d8ff; padding: 24px; text-align: center; border-radius: 12px; background: #f0f9ff; transition: background 0.2s; }
        .csv-box:hover { background: #e7f5ff; border-color: var(--primary-color); }
        .csv-hint { font-size: 13px; color: #666; margin-top: 12px; text-align: left; line-height: 1.6; background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #eee; }
        .title-setting-group { display: flex; gap: 10px; }
        .title-setting-group input { flex: 3; }
        .title-setting-group button { flex: 1; width: auto; }
        .filter-bar { display: flex; gap: 10px; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #eee; flex-wrap: wrap; align-items: center; }
        .filter-group { display: flex; align-items: center; gap: 5px; flex: 1; min-width: 150px; }
        .filter-select { padding: 8px; border-radius: 6px; border: 1px solid #ddd; background: #fff; flex: 1; }
        .search-input { padding: 8px; border-radius: 6px; border: 1px solid #ddd; flex: 2; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 id="appTitleDisplay" class="app-title">ğŸ’° OMI è¨˜å¸³æœ¬</h2>
        <div>
            <button class="mode-btn" id="btnLog" onclick="switchView('log')">ğŸ“ æµæ°´å¸³</button>
            <button class="mode-btn" id="btnStats" onclick="switchView('stats')">ğŸ“ˆ çµ±è¨ˆ</button>
            <button class="mode-btn active" id="btnBalance" onclick="switchView('balance')">ğŸ“Š è³‡ç”¢è¡¨</button>
            <button class="mode-btn" id="btnSettings" onclick="switchView('settings')">âš™ï¸ è¨­å®š</button>
        </div>
    </div>

    <div id="viewBalance">
        <div class="summary-bar">
            <div class="summary-item" style="background: var(--asset-yellow); color: #333;"><span class="summary-label">ç¸½è³‡ç”¢ (Assets)</span><span class="summary-val" id="totalAssets">$0</span></div>
            <div class="summary-item" style="background: var(--liab-purple);"><span class="summary-label">ç¸½è² å‚µ (Liabilities)</span><span class="summary-val" id="totalLiabilities">$0</span></div>
            <div class="summary-item" style="background: var(--net-red);"><span class="summary-label">æ·¨è³‡ç”¢ (Net Worth)</span><span class="summary-val" id="netWorth">$0</span></div>
        </div>
        <div class="balance-grid" id="balanceContainer"></div>
    </div>

    <div id="viewStats" class="hidden">
        <div class="card">
            <div class="stat-mode-switch">
                <button class="mode-switch-btn active" id="modeBtnMonth" onclick="setStatMode('month')">ğŸ“… æœˆæª¢è¦–</button>
                <button class="mode-switch-btn" id="modeBtnYear" onclick="setStatMode('year')">ğŸ“† å¹´æª¢è¦–</button>
            </div>
            <div class="month-selector">
                <button class="month-btn" onclick="changeStatDate(-1)">â®</button><span id="currentStatMonthLabel"></span><button class="month-btn" onclick="changeStatDate(1)">â¯</button>
            </div>
            <div class="stats-summary">
                <div class="stats-box" style="background: #40c057;"><span class="summary-label">æ”¶å…¥</span><span class="stats-val" id="statIncTotal">$0</span></div>
                <div class="stats-box" style="background: #fa5252;"><span class="summary-label">æ”¯å‡º</span><span class="stats-val" id="statExpTotal">$0</span></div>
                <div class="stats-box" style="background: #228be6;"><span class="summary-label">çµé¤˜</span><span class="stats-val" id="statNetTotal">$0</span></div>
            </div>
            <div class="stats-tabs">
                <div class="stats-tab exp active" id="tabExp" onclick="switchStatTab('æ”¯å‡º')">æ”¯å‡ºåˆ†æ</div><div class="stats-tab inc" id="tabInc" onclick="switchStatTab('æ”¶å…¥')">æ”¶å…¥åˆ†æ</div>
            </div>
            <div id="statsListContainer"></div>
        </div>
    </div>

    <div id="viewLog" class="hidden">
        <div class="card" id="inputCard">
            <h3 style="margin-top:0; font-size:16px; color:#666;" id="formTitle">æ–°å¢ä¸€ç­†äº¤æ˜“</h3>
            <div class="input-grid">
                <div class="col-date"><label>æ—¥æœŸ</label><input type="date" id="dateInput"></div>
                <div class="col-acc"><label id="accLabel">å¸³æˆ¶</label><select id="accountInput" onchange="handleAccountChange()"></select></div>
                <div class="col-type"><label>æ”¶æ”¯</label><select id="typeInput" onchange="handleTypeChange()"><option value="æ”¯å‡º">æ”¯å‡º</option><option value="æ”¶å…¥">æ”¶å…¥</option><option value="è½‰å¸³/ç¹³è²»">è½‰å¸³/ç¹³è²»</option><option value="ä¸è¨ˆå…¥">ä¸è¨ˆå…¥</option></select></div>
                
                <div class="col-sub-acc" id="subAccGroup" style="display:none;">
                    <label>æŒ‡å®šå­å¸³æˆ¶/é ç®—</label>
                    <select id="subAccountInput" style="border-color: #fcc419; background: #fff9db;"><option value="">(ç„¡)</option></select>
                    <small style="color: #999; font-size: 11px;">â€» å¯é¸æ“‡ä»»æ„éŠ€è¡Œçš„å­å¸³æˆ¶é ç®—</small>
                </div>
                
                <div class="col-to-acc hidden" id="toAccGroup">
                    <label>è½‰å…¥/ç¹³è²»è‡³</label>
                    <select id="toAccountInput"></select>
                </div>

                <div class="col-amt"><label>é‡‘é¡</label><input type="number" id="amountInput" placeholder="0"></div>
                <div class="col-cat" id="catGroup"><label>é¡åˆ¥</label><select id="categoryInput"></select></div>
                <div class="col-desc"><label>æè¿°</label><input type="text" id="descInput"></div>
                <div class="col-btn"><button class="action-btn" id="mainActionBtn" onclick="handleTransactionSubmit()">ï¼‹ æ–°å¢</button><button class="action-btn cancel-mode hidden" id="cancelEditBtn" onclick="cancelEditMode()">å–æ¶ˆä¿®æ”¹</button></div>
            </div>
        </div>
        <div class="filter-bar">
            <div class="filter-group"><span>ğŸ“… æœˆä»½ï¼š</span><select id="logFilterMonth" class="filter-select" onchange="renderTable()"><option value="all">å…¨éƒ¨é¡¯ç¤º</option></select></div>
            <div class="filter-group"><span>ğŸ” æœå°‹ï¼š</span><input type="text" id="logSearchInput" class="search-input" placeholder="é¡åˆ¥ / æè¿° / é‡‘é¡..." onkeyup="renderTable()"></div>
        </div>
        <div class="card" style="padding:0; overflow-x: auto;">
            <table><thead><tr><th>æ—¥æœŸ <button class="sort-btn" id="dateSortBtn" onclick="toggleDateSort()">â–¼</button></th><th>å¸³æˆ¶ (å­å¸³æˆ¶)</th><th>æ”¶æ”¯</th><th>é‡‘é¡</th><th>é¡åˆ¥</th><th>æè¿°</th><th>æ“ä½œ</th></tr></thead><tbody id="transactionList"></tbody></table>
        </div>
    </div>

    <div id="viewSettings" class="hidden">
        <div class="card"><h3>ğŸ·ï¸ APP åç¨±è¨­å®š</h3><div class="title-setting-group"><input type="text" id="appNameInput" placeholder="è¼¸å…¥æ¨™é¡Œ"><button class="action-btn" onclick="saveAppName()">å„²å­˜åç¨±</button></div></div>
        
        <div class="card">
            <h3>ğŸ’¾ è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h3>
            <div style="display:flex; gap:10px;">
                <button onclick="exportData()" style="flex:1;background:#40c057;color:white;border:none;padding:10px;border-radius:6px;cursor:pointer;font-weight:bold;">â¬‡ï¸ ä¸‹è¼‰å‚™ä»½ (JSON)</button>
                <button onclick="document.getElementById('importFile').click()" style="flex:1;background:#fa5252;color:white;border:none;padding:10px;border-radius:6px;cursor:pointer;font-weight:bold;">â¬†ï¸ åŒ¯å…¥å‚™ä»½ (JSON)</button>
            </div>
            <input type="file" id="importFile" style="display:none;" onchange="importData(this)">
        </div>

        <div class="card"><h3>ğŸ¦ å¸³æˆ¶ç®¡ç†</h3><div class="color-picker-group" style="margin-bottom:15px;"><input type="text" id="newAccName" placeholder="åç¨±" style="flex:2;"><input type="color" id="newAccColor" value="#339af0" style="width:50px;height:40px;padding:2px;border:none;background:none;cursor:pointer;"><button class="action-btn" onclick="addAccount()" style="flex:1;margin-top:0;">æ–°å¢</button></div><ul id="settingsAccList" class="sortable-list"></ul></div>
        <div class="card"><h3>ğŸ“‚ é¡åˆ¥ç®¡ç†</h3><div style="display:flex;gap:10px;margin-bottom:10px;"><select id="catTypeSelect" style="width:120px;"><option value="æ”¯å‡º">æ”¯å‡º</option><option value="æ”¶å…¥">æ”¶å…¥</option><option value="ä¸è¨ˆå…¥">ä¸è¨ˆå…¥</option></select><input type="text" id="newCatName" placeholder="é¡åˆ¥åç¨±"><button onclick="addCategory()" style="width:80px;background:#eee;border:none;border-radius:4px;font-weight:bold;cursor:pointer;">æ–°å¢</button></div><ul id="settingsCatList" class="sortable-list"></ul></div>
        <div class="card" style="border-top: 4px solid #228be6;">
            <h3>ğŸ“¥ åŒ¯å…¥ / åŒ¯å‡º Excel (CSV)</h3>
            <div class="csv-box">
                <div style="margin-bottom:15px;">
                    <label>æª”æ¡ˆç·¨ç¢¼ï¼š</label>
                    <select id="csvEncoding"><option value="UTF-8">UTF-8 (Google è©¦ç®—è¡¨æ¨è–¦)</option><option value="Big5">Big5 (Excel é è¨­)</option></select>
                </div>
                <input type="file" id="csvFileInput" accept=".csv" />
                <button onclick="processCSV()" style="background:#228be6; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold;">é–‹å§‹åŒ¯å…¥</button>
            </div>
            <div style="margin-top: 20px; text-align: center; border-top: 1px dashed #ccc; padding-top: 20px;">
                <p style="font-weight:bold; margin-bottom:10px;">åŒ¯å‡ºè³‡æ–™</p>
                <button onclick="exportToCSV()" style="background:#15aabf; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold;">ğŸ“„ åŒ¯å‡º CSV æª”æ¡ˆ</button>
                <p style="font-size:12px; color:#666; margin-top:5px;">å¯ä½¿ç”¨ Excel é–‹å•Ÿç·¨è¼¯</p>
            </div>
        </div>
    </div>
</div>

<div id="subAccModalOverlay" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <span id="modalTitle">åˆ†é…å­å¸³æˆ¶ (å¹´åº¦é ç®—)</span>
            <span class="close-modal-btn" onclick="closeSubAccModal()">âœ•</span>
        </div>
        <div style="font-size:13px; color:#666; margin-bottom:10px;">è«‹è¼¸å…¥è©²é …ç›®çš„ã€Œæœ¬å¹´åº¦é ç®—ã€æˆ–ã€Œå°ˆæ¬¾é‡‘é¡ã€ã€‚(å¯æ‹–æ›³æ’åº)</div>
        <div class="modal-body" id="modalBody"></div>
        <button class="add-row-btn" onclick="addNewSubRow()">ï¼‹ æ·»åŠ ä¸€è¡Œ</button>
        <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
            <button class="action-btn" onclick="saveSubAccounts()">å„²å­˜è¨­å®š</button>
        </div>
    </div>
</div>

<div id="adjustModalOverlay" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <span id="adjModalTitle">âš–ï¸ é¤˜é¡æ ¡æ­£</span>
            <span class="close-modal-btn" onclick="closeAdjustModal()">âœ•</span>
        </div>
        <div style="padding: 10px 0;">
            <label style="display:block; margin-bottom:5px; font-weight:bold;">é¸æ“‡å°è±¡:</label>
            <select id="adjSubAccSelect" style="width:100%; padding:10px; margin-bottom:15px; font-size:16px;" onchange="updateAdjCurrentBalance()">
                </select>
            
            <p style="color:#666; font-size:14px; margin:0 0 10px 0;">ç³»çµ±ç´€éŒ„é¤˜é¡: <strong id="adjCurrentBal" style="font-size:18px; color:#333;">$0</strong></p>
            <label style="display:block; margin-bottom:5px; font-weight:bold;">ç•¶å‰å¯¦éš›é¤˜é¡ (å¸‚å€¼):</label>
            <input type="number" id="adjTargetInput" placeholder="è¼¸å…¥å¯¦éš›é‡‘é¡..." style="font-size:18px; padding:10px; width:100%; box-sizing:border-box;" oninput="calcAdjDiff()">
            
            <div style="margin-top:15px; background:#f8f9fa; padding:10px; border-radius:8px; border-left:4px solid #ccc;" id="adjDiffBox">
                <span style="font-size:13px; color:#666;">ç³»çµ±å°‡è‡ªå‹•æ–°å¢ä¸€ç­†ï¼š</span><br>
                <strong id="adjType" style="color:#333;">-</strong> 
                <span id="adjDiffVal" style="font-size:16px; font-weight:bold; margin-left:5px;">$0</span>
                <div style="font-size:12px; color:#999; margin-top:5px;">é¡åˆ¥: <span id="adjCatName">æŠ•è³‡æç›Š</span></div>
            </div>
        </div>
        <button class="action-btn" style="background-color: #6610f2;" onclick="submitAdjustment()">ç¢ºèªæ ¡æ­£</button>
    </div>
</div>

<script>
    // PWA Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('Service Worker registered', reg))
                .catch(err => console.log('Service Worker registration failed', err));
        });
    }

    const defaultData = {
        appName: 'ğŸ’° è¨˜å¸³æœ¬',
        accounts: ['å°æ–°', 'å°æ–°ä¿¡ç”¨å¡', 'è¯å—', 'åœ‹æ³°', 'åœ‹æ³°ä¿¡ç”¨å¡', 'åœ‹æ³°è­‰åˆ¸'],
        accountColors: { 'å°æ–°': '#e03131', 'å°æ–°ä¿¡ç”¨å¡': '#9c36b5', 'è¯å—': '#c92a2a', 'åœ‹æ³°': '#2f9e44', 'åœ‹æ³°ä¿¡ç”¨å¡': '#862e9c', 'åœ‹æ³°è­‰åˆ¸': '#5c940d' },
        categories: { 'æ”¯å‡º': ['ç”Ÿæ´»è²»', 'é£²é£Ÿ', 'äº¤é€š', 'è³¼ç‰©', 'å®¶ç”¨', 'è²¸æ¬¾'], 'æ”¶å…¥': ['è–ªè³‡', 'å¹´çµ‚', 'è‚¡åˆ©', 'åˆ©æ¯', 'æŠ•è³‡æç›Š', 'é¤˜é¡è¨­å®š'], 'ä¸è¨ˆå…¥': ['è½‰å¸³', 'æ›åŒ¯', 'ç¹³å¡è²»'] },
        transactions: [],
        subAccounts: {} 
    };
    let appData = JSON.parse(localStorage.getItem('myMoneyV146')) || defaultData;
    if(!appData.accountColors) appData.accountColors = defaultData.accountColors;
    if(!appData.subAccounts) appData.subAccounts = {}; 
    if(appData.accounts) { appData.accounts.forEach(acc => { if(!appData.accountColors[acc]) appData.accountColors[acc] = '#339af0'; }); }

    let editingId = null, editingItem = null;
    let statYear = new Date().getFullYear(), statMonth = new Date().getMonth() + 1, currentStatType = 'æ”¯å‡º';
    let sortOrder = 'desc'; 
    let statMode = 'month'; 
    let currentEditingAcc = ''; 
    let tempSubAccounts = []; 

    // Adjustment Vars
    let adjMainAccount = '';

    function saveData() { localStorage.setItem('myMoneyV146', JSON.stringify(appData)); }

    window.onload = function() {
        document.getElementById('dateInput').valueAsDate = new Date();
        updateAppTitleUI();
        renderDropdowns(); renderSettings(); calculateAndRenderBalance(); renderStats();
        initLogFilters(); renderTable(); 
    };

    // === V14.1 æ ¡æ­£åŠŸèƒ½ ===
    function openBalanceAdjustModal(accName) {
        adjMainAccount = accName;
        document.getElementById('adjModalTitle').innerText = `æ ¡æ­£ ${accName} é¤˜é¡`;
        
        const select = document.getElementById('adjSubAccSelect');
        let options = `<option value="">${accName} (æ•´æˆ¶ç¸½é¡)</option>`;
        
        const subs = appData.subAccounts[accName] || [];
        subs.forEach(s => {
            options += `<option value="${s.name}">${s.name}</option>`;
        });
        select.innerHTML = options;
        
        updateAdjCurrentBalance(); 
        document.getElementById('adjTargetInput').value = '';
        document.getElementById('adjDiffVal').innerText = '$0';
        document.getElementById('adjType').innerText = '-';
        document.getElementById('adjDiffBox').style.borderLeftColor = '#ccc';
        
        document.getElementById('adjustModalOverlay').classList.add('active');
    }

    function closeAdjustModal() {
        document.getElementById('adjustModalOverlay').classList.remove('active');
    }

    function getCurrentBalance(mainAcc, subName) {
        let total = 0;
        appData.transactions.forEach(tx => {
            if (tx.account === mainAcc) {
                if (subName) {
                    if (tx.subAccount === subName || tx.subAccount === `${mainAcc}::${subName}`) {
                        total += tx.amount;
                    }
                } else {
                    total += tx.amount;
                }
            }
        });
        return total;
    }

    function updateAdjCurrentBalance() {
        const subName = document.getElementById('adjSubAccSelect').value;
        const bal = getCurrentBalance(adjMainAccount, subName);
        document.getElementById('adjCurrentBal').innerText = '$' + bal.toLocaleString();
        document.getElementById('adjCurrentBal').dataset.val = bal;
        calcAdjDiff();
    }

    function calcAdjDiff() {
        const currentBal = parseFloat(document.getElementById('adjCurrentBal').dataset.val) || 0;
        const target = parseFloat(document.getElementById('adjTargetInput').value);
        
        if (isNaN(target)) {
            document.getElementById('adjDiffVal').innerText = '$0';
            document.getElementById('adjType').innerText = '-';
            return;
        }

        const diff = target - currentBal;
        const typeLabel = document.getElementById('adjType');
        const valLabel = document.getElementById('adjDiffVal');
        const box = document.getElementById('adjDiffBox');

        if (diff > 0) {
            typeLabel.innerText = "æ”¶å…¥";
            typeLabel.style.color = "var(--success-color)";
            valLabel.innerText = "+$" + diff.toLocaleString();
            valLabel.style.color = "var(--success-color)";
            box.style.borderLeftColor = "var(--success-color)";
        } else if (diff < 0) {
            typeLabel.innerText = "æ”¯å‡º";
            typeLabel.style.color = "var(--danger-color)";
            valLabel.innerText = "-$" + Math.abs(diff).toLocaleString();
            valLabel.style.color = "var(--danger-color)";
            box.style.borderLeftColor = "var(--danger-color)";
        } else {
            typeLabel.innerText = "ç„¡è®Šå‹•";
            valLabel.innerText = "$0";
            box.style.borderLeftColor = "#ccc";
        }
    }

    function submitAdjustment() {
        const subName = document.getElementById('adjSubAccSelect').value;
        const currentBal = parseFloat(document.getElementById('adjCurrentBal').dataset.val) || 0;
        const target = parseFloat(document.getElementById('adjTargetInput').value);
        
        if (isNaN(target)) return alert("è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡");

        const diff = target - currentBal;
        if (diff === 0) {
            alert("é‡‘é¡ç„¡è®Šå‹•");
            closeAdjustModal();
            return;
        }

        const type = diff > 0 ? 'ä¸è¨ˆå…¥' : 'æ”¯å‡º';
        const category = "é¤˜é¡è¨­å®š"; 

        if (!appData.categories[type] && type !== 'ä¸è¨ˆå…¥') {
             // ç¢ºä¿é¡åˆ¥
        }

        const today = new Date().toISOString().slice(0, 10);
        let subAccountVal = "";
        if (subName) {
             subAccountVal = `${adjMainAccount}::${subName}`;
        }

        appData.transactions.unshift({
            id: Date.now(),
            date: today,
            account: adjMainAccount,
            type: type,
            amount: diff, 
            category: category,
            desc: "é¤˜é¡æ ¡æ­£/åˆå§‹è¨­å®š",
            subAccount: subAccountVal
        });

        saveData();
        closeAdjustModal();
        alert(`âœ… æ ¡æ­£å®Œæˆï¼å·²æ–°å¢ä¸€ç­† ${type} $${diff.toLocaleString()}`);
        calculateAndRenderBalance();
        renderTable();
        initLogFilters();
    }

    // === é€šç”¨åŠŸèƒ½ ===
    function exportData(){ 
        const a=document.createElement('a'); 
        a.href='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(appData)); 
        a.download='money_backup_v146.json'; 
        a.click(); 
    }

    function exportToCSV() {
        if (!appData.transactions || appData.transactions.length === 0) { alert("ç„¡è³‡æ–™å¯åŒ¯å‡ºï¼"); return; }
        const headers = ["æ—¥æœŸ", "å¸³æˆ¶", "æ”¶æ”¯", "é‡‘é¡", "é¡åˆ¥", "æè¿°", "å­å¸³æˆ¶"];
        const rows = appData.transactions.map(tx => {
            const sub = tx.subAccount || "";
            const desc = (tx.desc || "").replace(/"/g, '""'); 
            return [tx.date, tx.account, tx.type, tx.amount, tx.category, `"${desc}"`, sub];
        });
        const csvContent = "\uFEFF" + [headers, ...rows].map(e => e.join(",")).join("\n");
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `money_export_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function openSubAccModal(accName) {
        currentEditingAcc = accName;
        document.getElementById('modalTitle').innerText = `åˆ†é… ${accName} çš„å­å¸³æˆ¶`;
        document.getElementById('subAccModalOverlay').classList.add('active');
        tempSubAccounts = JSON.parse(JSON.stringify(appData.subAccounts[accName] || []));
        renderSubAccInputs();
    }
    function closeSubAccModal() { document.getElementById('subAccModalOverlay').classList.remove('active'); }
    function addNewSubRow() { syncTempFromInputs(); tempSubAccounts.push({ name: '', amount: 0 }); renderSubAccInputs(); setTimeout(() => { document.getElementById('modalBody').scrollTop = document.getElementById('modalBody').scrollHeight; }, 50); }
    function syncTempFromInputs() { const rows = document.querySelectorAll('.sub-edit-item'); rows.forEach((row, idx) => { if (tempSubAccounts[idx]) { tempSubAccounts[idx].name = document.getElementById(`tempSubName_${idx}`).value; tempSubAccounts[idx].amount = parseFloat(document.getElementById(`tempSubAmt_${idx}`).value) || 0; } }); }
    function renderSubAccInputs() { const container = document.getElementById('modalBody'); let html = ''; tempSubAccounts.forEach((sub, idx) => { html += `<div class="sub-edit-item" draggable="true" data-index="${idx}"><span class="drag-handle">â‰¡</span><input type="text" placeholder="åç¨±" value="${sub.name}" id="tempSubName_${idx}"><input type="number" placeholder="é ç®—" value="${sub.amount}" id="tempSubAmt_${idx}"><button class="del-sub-btn" onclick="removeSubRow(${idx})">âœ•</button></div>`; }); container.innerHTML = html; addModalDragEvents(); }
    function removeSubRow(idx) { syncTempFromInputs(); tempSubAccounts.splice(idx, 1); renderSubAccInputs(); }
    function saveSubAccounts() { syncTempFromInputs(); appData.subAccounts[currentEditingAcc] = tempSubAccounts.filter(s => s.name.trim() !== ''); saveData(); closeSubAccModal(); calculateAndRenderBalance(); }
    function addModalDragEvents() { const items = document.querySelectorAll('.sub-edit-item'); let dragStartIndex; items.forEach(item => { item.addEventListener('dragstart', () => { dragStartIndex = +item.getAttribute('data-index'); item.classList.add('dragging'); }); item.addEventListener('dragover', (e) => e.preventDefault()); item.addEventListener('drop', (e) => { const dragEndIndex = +item.getAttribute('data-index'); syncTempFromInputs(); swapTempItems(dragStartIndex, dragEndIndex); item.classList.remove('dragging'); }); item.addEventListener('dragend', () => item.classList.remove('dragging')); }); }
    function swapTempItems(from, to) { if(from === to) return; const item = tempSubAccounts.splice(from, 1)[0]; tempSubAccounts.splice(to, 0, item); renderSubAccInputs(); }

    // === V14.6 ä¿®å¾©ï¼šç§»é™¤å­å¸³æˆ¶çš„å¹´ä»½é™åˆ¶ ===
    function calculateAndRenderBalance() {
        let balances = {}; appData.accounts.forEach(acc => balances[acc] = 0);
        let subSpentMap = {}; 
        
        // ç§»é™¤å¹´ä»½éæ¿¾ï¼Œè¨ˆç®—æ‰€æœ‰æ­·å²äº¤æ˜“
        appData.transactions.forEach(tx => { 
            if(balances[tx.account]===undefined) balances[tx.account]=0; 
            balances[tx.account] += tx.amount; 
            
            // åªè¦æœ‰ subAccount å°±è¨ˆç®—ï¼Œä¸è«–å¹´ä»½
            if (tx.subAccount) {
                let mainAcc = tx.account; let subName = tx.subAccount;
                if (tx.subAccount.includes('::')) { const parts = tx.subAccount.split('::'); mainAcc = parts[0]; subName = parts[1]; }
                let key = mainAcc + '_' + subName; 
                
                // Logic Fix V14.5 + V14.6:
                if (tx.amount < 0) {
                     subSpentMap[key] = (subSpentMap[key] || 0) + Math.abs(tx.amount);
                } else {
                     subSpentMap[key] = (subSpentMap[key] || 0) - tx.amount;
                }
            }
        });
        
        let totalAsset=0, totalLiab=0;
        const container = document.getElementById('balanceContainer'); container.innerHTML = '';
        appData.accounts.forEach(acc => {
            let bal = balances[acc]; 
            if(bal>0) totalAsset+=bal; else totalLiab+=bal;
            let color = appData.accountColors[acc] || '#ccc';
            let moneyClass = bal < 0 ? 'color: #c92a2a;' : 'color: #333;';
            let subHtml = '';
            const subs = appData.subAccounts[acc] || [];
            if (subs.length > 0) {
                subHtml = '<ul class="sub-account-list">';
                let sumRemaining = 0;
                subs.forEach(s => {
                    let key = acc + '_' + s.name; 
                    let used = subSpentMap[key] || 0; // æ·¨æ”¯å‡º
                    let remaining = s.amount - used;  // é ç®— - æ·¨æ”¯å‡º
                    sumRemaining += remaining;
                    
                    let percent = 0;
                    if (s.amount > 0) {
                        let val = (s.amount - remaining);
                        percent = Math.max(0, Math.min(100, (val / s.amount) * 100));
                    }
                    
                    let barColor = remaining < 0 ? '#fa5252' : 'var(--primary-color)';
                    subHtml += `<li class="sub-account-item"><div class="sub-row-main"><span>${s.name}</span><span style="font-weight:bold; color:${remaining<0?'red':'#555'}">$${remaining.toLocaleString()}</span></div><div class="sub-progress-bg"><div class="sub-progress-fill" style="width:${percent}%; background:${barColor}"></div></div><div class="sub-info"><span>é ç®—/æœŸåˆ: $${s.amount.toLocaleString()}</span><span>ç¾å€¼: $${remaining.toLocaleString()}</span></div></li>`;
                });
                const unallocated = bal - sumRemaining;
                if (unallocated !== 0) subHtml += `<li class="sub-account-item unallocated"><span>âš ï¸ æœªåˆ†é…/é–’ç½®</span><span>$${unallocated.toLocaleString()}</span></li>`;
                subHtml += '</ul>';
            }
            container.innerHTML += `
            <div class="balance-card" style="border-top-color:${color}">
                <div class="balance-header">
                    <span style="display:flex;align-items:center;"><span class="color-dot" style="background:${color};margin-right:8px;"></span>${acc}</span>
                    <span class="balance-val" style="${moneyClass}">${bal.toLocaleString()}</span>
                </div>
                ${subHtml}
                <div class="card-actions">
                    <button class="card-action-btn" onclick="openSubAccModal('${acc}')">âš™ï¸ è¨­å®šå­å¸³æˆ¶</button>
                    <button class="card-action-btn" onclick="openBalanceAdjustModal('${acc}')">âš–ï¸ æ ¡æ­£é¤˜é¡</button>
                </div>
            </div>`;
        });
        document.getElementById('totalAssets').innerText = '$'+totalAsset.toLocaleString();
        document.getElementById('totalLiabilities').innerText = '$'+totalLiab.toLocaleString();
        document.getElementById('netWorth').innerText = '$'+(totalAsset+totalLiab).toLocaleString();
    }

    function updateAppTitleUI() { document.getElementById('appTitleDisplay').innerText = appData.appName; document.getElementById('appNameInput').value = appData.appName; }
    function saveAppName() { const newName = document.getElementById('appNameInput').value.trim(); if(newName) { appData.appName = newName; saveData(); updateAppTitleUI(); alert('APP åç¨±å·²æ›´æ–°ï¼'); } }
    function handleTypeChange() {
        const type = document.getElementById('typeInput').value;
        const catGroup = document.getElementById('catGroup'); const toAccGroup = document.getElementById('toAccGroup'); const accLabel = document.getElementById('accLabel'); const mainBtn = document.getElementById('mainActionBtn');
        const subAccGroup = document.getElementById('subAccGroup');
        if (type === 'è½‰å¸³/ç¹³è²»') { 
            catGroup.classList.add('hidden'); 
            toAccGroup.classList.remove('hidden'); 
            accLabel.innerText = "è½‰å‡ºå¸³æˆ¶"; 
            mainBtn.innerText = "â¡ï¸ åŸ·è¡Œè½‰å¸³/ç¹³è²»"; 
            mainBtn.classList.add('transfer-mode-btn'); 
            subAccGroup.style.display='none'; 
            renderToAccountOptions();
        } 
        else { 
            catGroup.classList.remove('hidden'); 
            toAccGroup.classList.add('hidden'); 
            accLabel.innerText = "å¸³æˆ¶"; 
            mainBtn.innerText = editingId ? "ğŸ’¾ å„²å­˜ä¿®æ”¹" : "ï¼‹ æ–°å¢"; 
            mainBtn.classList.remove('transfer-mode-btn'); 
            updateCategorySelect(); 
            handleAccountChange(); 
        }
    }

    function renderToAccountOptions() {
        const select = document.getElementById('toAccountInput');
        let options = '';
        appData.accounts.forEach(acc => {
            options += `<option value="${acc}">${acc}</option>`;
            const subs = appData.subAccounts[acc] || [];
            subs.forEach(s => {
                options += `<option value="${acc}::${s.name}">â”” ${s.name}</option>`;
            });
        });
        select.innerHTML = options;
    }

    function handleAccountChange() {
        const mainAcc = document.getElementById('accountInput').value;
        const subAccSelect = document.getElementById('subAccountInput');
        const subAccGroup = document.getElementById('subAccGroup');
        const type = document.getElementById('typeInput').value;
        if (type === 'è½‰å¸³/ç¹³è²»') { subAccGroup.style.display = 'none'; return; }
        
        let optionsHtml = '<option value="">(ç„¡)</option>';
        let hasSub = false;

        appData.accounts.forEach(acc => {
            const subs = appData.subAccounts[acc] || [];
            if (subs.length > 0) {
                hasSub = true;
                optionsHtml += `<optgroup label="${acc}">`;
                subs.forEach(s => {
                    optionsHtml += `<option value="${acc}::${s.name}">${s.name}</option>`;
                });
                optionsHtml += `</optgroup>`;
            }
        });

        if (hasSub) {
            subAccGroup.style.display = 'grid'; 
            subAccSelect.innerHTML = optionsHtml; 
        } else { 
            subAccGroup.style.display = 'none'; 
            subAccSelect.innerHTML = '<option value="">(ç„¡)</option>'; 
        }
    }

    function handleTransactionSubmit() {
        const d=document.getElementById('dateInput').value; const t=document.getElementById('typeInput').value; const a=document.getElementById('accountInput').value; const amtInput=parseFloat(document.getElementById('amountInput').value); const desc=document.getElementById('descInput').value;
        const subAcc = document.getElementById('subAccountInput') ? document.getElementById('subAccountInput').value : '';
        
        if(!d || isNaN(amtInput) || !a) return alert('è«‹å®Œæ•´è¼¸å…¥');
        
        if (t === 'è½‰å¸³/ç¹³è²»') {
            const toAccVal = document.getElementById('toAccountInput').value;
            let toMainAcc = toAccVal;
            let toSubAcc = "";
            if (toAccVal.includes('::')) {
                const parts = toAccVal.split('::');
                toMainAcc = parts[0];
                toSubAcc = toAccVal;
            }

            if(a === toMainAcc && !toSubAcc) return alert('è½‰å‡ºèˆ‡è½‰å…¥å¸³æˆ¶ä¸èƒ½ç›¸åŒ');
            
            const amount = Math.abs(amtInput); 
            const txOut = { id: Date.now(), date: d, account: a, type: 'ä¸è¨ˆå…¥', amount: -amount, category: 'è½‰å¸³-è½‰å‡º', desc: `è½‰è‡³ ${toMainAcc} ${desc ? '('+desc+')' : ''}`, subAccount: "" }; 
            const txIn = { id: Date.now() + 1, date: d, account: toMainAcc, type: 'ä¸è¨ˆå…¥', amount: amount, category: 'è½‰å¸³-è½‰å…¥', desc: `ä¾†è‡ª ${a} ${desc ? '('+desc+')' : ''}`, subAccount: toSubAcc }; 
            
            if (editingId !== null) { appData.transactions = appData.transactions.filter(x => x.id != editingId); editingId = null; cancelEditMode(); }

            appData.transactions.unshift(txOut, txIn); alert(`âœ… è½‰å¸³æˆåŠŸï¼`);
            document.getElementById('amountInput').value=''; document.getElementById('descInput').value=''; saveData(); renderTable(); calculateAndRenderBalance(); return;
        }
        let amt = amtInput; const c=document.getElementById('categoryInput').value;
        if(t==='æ”¯å‡º'&&amt>0) amt=-amt; if(t==='æ”¶å…¥'&&amt<0) amt=Math.abs(amt);
        const txObj = {id:Date.now(),date:d,account:a,type:t,amount:amt,category:c,desc:desc, subAccount: subAcc};
        if(editingId!==null) { const idx=appData.transactions.findIndex(x=>x.id==editingId); if(idx!==-1) { txObj.id = editingId; appData.transactions[idx]=txObj; } cancelEditMode(); } 
        else { appData.transactions.unshift(txObj); document.getElementById('amountInput').value=''; document.getElementById('descInput').value=''; }
        saveData(); initLogFilters(); renderTable(); calculateAndRenderBalance();
    }

    function initLogFilters() { const months = new Set(); appData.transactions.forEach(tx => { const m = tx.date.slice(0, 7); if(m) months.add(m); }); const sortedMonths = Array.from(months).sort().reverse(); const select = document.getElementById('logFilterMonth'); const currentVal = select.value; const today = new Date(); const currentMonthStr = today.toISOString().slice(0, 7); let optionsHtml = '<option value="all">å…¨éƒ¨é¡¯ç¤º</option>'; sortedMonths.forEach(m => { optionsHtml += `<option value="${m}">${m}</option>`; }); select.innerHTML = optionsHtml; if (currentVal === 'all' && sortedMonths.includes(currentMonthStr)) { select.value = currentMonthStr; } else if (currentVal !== 'all') { select.value = currentVal; } }
    function renderTable(){
        const filterMonth = document.getElementById('logFilterMonth').value; const searchKeyword = document.getElementById('logSearchInput').value.toLowerCase();
        let displayData = appData.transactions.filter(tx => { if (filterMonth !== 'all' && !tx.date.startsWith(filterMonth)) return false; if (searchKeyword) { const content = `${tx.account} ${tx.category} ${tx.desc} ${tx.amount} ${tx.type}`.toLowerCase(); if (!content.includes(searchKeyword)) return false; } return true; });
        displayData.sort((a, b) => { if (sortOrder === 'desc') { return b.date.localeCompare(a.date) || b.id - a.id; } else { return a.date.localeCompare(b.date) || a.id - b.id; } });
        const b = document.getElementById('transactionList'); 
        if (displayData.length === 0) { b.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px; color:#999;">æ²’æœ‰ç¬¦åˆçš„è³‡æ–™</td></tr>'; return; }
        b.innerHTML = displayData.map(tx=>{ 
            let color = appData.accountColors[tx.account]||'#ccc'; 
            let accDisplay = tx.account; 
            if(tx.subAccount) {
                let subNameDisplay = tx.subAccount;
                if (tx.subAccount.includes('::')) {
                    const parts = tx.subAccount.split('::');
                    if(parts[0] !== tx.account) { subNameDisplay = `${parts[0]}-${parts[1]}`; } else { subNameDisplay = parts[1]; }
                }
                accDisplay += ` <span style="font-size:11px; color:#666;">(${subNameDisplay})</span>`;
            }
            return `<tr><td>${tx.date.slice(5)}</td><td><span class="tag" style="background:${color}">${accDisplay}</span></td><td><span style="font-size:12px;color:#666">${tx.type}</span></td><td style="font-family:monospace;font-weight:bold;color:${tx.amount<0?'#c92a2a':'#333'}">${tx.amount}</td><td>${tx.category}</td><td style="color:#666">${tx.desc}</td><td><button class="icon-btn edit-btn" onclick="startEdit(${tx.id})">âœ</button><button class="icon-btn del-btn" onclick="deleteTx(${tx.id})">ğŸ—‘ï¸</button></td></tr>`; 
        }).join('');
    }
    function switchStatTab(t) { currentStatType = t; const tabExp = document.getElementById('tabExp'); const tabInc = document.getElementById('tabInc'); if (t === 'æ”¯å‡º') { tabExp.classList.add('active'); tabInc.classList.remove('active'); } else { tabExp.classList.remove('active'); tabInc.classList.add('active'); } renderStatsList(); }
    function setStatMode(mode) { statMode = mode; document.getElementById('modeBtnMonth').className = mode === 'month' ? 'mode-switch-btn active' : 'mode-switch-btn'; document.getElementById('modeBtnYear').className = mode === 'year' ? 'mode-switch-btn active' : 'mode-switch-btn'; renderStats(); }
    function changeStatDate(delta) { if (statMode === 'month') { statMonth += delta; if (statMonth > 12) { statMonth = 1; statYear++; } if (statMonth < 1) { statMonth = 12; statYear--; } } else { statYear += delta; } renderStats(); }
    function getLocalMonthRange(year, month) { const startStr = `${year}-${String(month).padStart(2,'0')}-01`; const lastDay = new Date(year, month, 0).getDate(); const endStr = `${year}-${String(month).padStart(2,'0')}-${lastDay}`; return { start: startStr, end: endStr }; }
    function getDateRange() { if (statMode === 'month') { return getLocalMonthRange(statYear, statMonth); } else { return { start: `${statYear}-01-01`, end: `${statYear}-12-31` }; } }
    function renderStats() { const title = statMode === 'month' ? `${statYear}å¹´ ${String(statMonth).padStart(2,'0')}æœˆ` : `${statYear}å¹´ å…¨å¹´åº¦`; document.getElementById('currentStatMonthLabel').innerText = title; const { start, end } = getDateRange(); const txs = appData.transactions.filter(t => t.date >= start && t.date <= end); let i=0, e=0; txs.forEach(t=>{ if(t.type==='æ”¶å…¥')i+=t.amount; if(t.type==='æ”¯å‡º')e+=Math.abs(t.amount); }); document.getElementById('statIncTotal').innerText='$'+i.toLocaleString(); document.getElementById('statExpTotal').innerText='$'+e.toLocaleString(); document.getElementById('statNetTotal').innerText='$'+(i-e).toLocaleString(); renderStatsList(txs); }
    function renderStatsList(txs) { if(!txs) { const { start, end } = getDateRange(); txs = appData.transactions.filter(t => t.date >= start && t.date <= end); } let map={}; let tot=0; const filteredTxs = txs.filter(t=>t.type===currentStatType); filteredTxs.forEach(t=>{ let c = t.category || 'æœªåˆ†é¡'; if(!map[c]) map[c]={total:0,items:[]}; let v=Math.abs(t.amount); map[c].total+=v; map[c].items.push(t); tot+=v; }); const list = Object.keys(map).map(k=>({name:k, ...map[k]})).sort((a,b)=>b.total-a.total); const c = document.getElementById('statsListContainer'); c.innerHTML=''; if(list.length===0) { c.innerHTML='<div style="text-align:center;padding:20px;color:#ccc">ç„¡è³‡æ–™</div>'; return; } list.forEach(cat=>{ const pct = tot>0?(cat.total/tot*100).toFixed(1):0; const det = cat.items.map(i=>`<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:13px;color:#666"><span>${i.date.slice(5)} - ${i.desc||''} (${i.account})</span><span>$${Math.abs(i.amount).toLocaleString()}</span></div>`).join(''); const barColor = currentStatType === 'æ”¯å‡º' ? '#fa5252' : '#40c057'; c.innerHTML+=`<div class="cat-stats-item" onclick="this.classList.toggle('open')"><div class="cat-row"><span>${cat.name}</span><span>$${cat.total.toLocaleString()} (${pct}%)</span></div><div class="cat-bar-bg"><div class="cat-bar-fill" style="width:${pct}%;background:${barColor}"></div></div><div class="cat-details">${det}</div></div>`; }); }
    function toggleDateSort() { sortOrder = sortOrder === 'desc' ? 'asc' : 'desc'; document.getElementById('dateSortBtn').innerText = sortOrder === 'desc' ? 'â–¼' : 'â–²'; renderTable(); }
    
    function parseCSVLine(text) { const result = []; let cell = ''; let inQuotes = false; for (let i = 0; i < text.length; i++) { const char = text[i]; if (char === '"') inQuotes = !inQuotes; else if (char === ',' && !inQuotes) { result.push(cell); cell = ''; } else cell += char; } result.push(cell); return result.map(c => c.trim().replace(/^"|"$/g, '').replace(/""/g, '"')); }
    function processCSV() { const fileInput = document.getElementById('csvFileInput'); const file = fileInput.files[0]; const encoding = document.getElementById('csvEncoding').value; if (!file) return alert("è«‹å…ˆé¸æ“‡ CSV æª”æ¡ˆ"); const reader = new FileReader(); reader.onload = function(e) { const text = e.target.result; const rows = text.replace(/\r\n/g, '\n').split('\n'); if(rows.length < 2) return alert("æª”æ¡ˆå…§å®¹ç‚ºç©º"); const headers = parseCSVLine(rows[0]); const idxDate = headers.findIndex(h => h.includes('æ—¥æœŸ')); const idxAcc = headers.findIndex(h => h.includes('å¸³æˆ¶')); const idxType = headers.findIndex(h => h.includes('æ”¶æ”¯')); const idxAmt = headers.findIndex(h => h.includes('é‡‘é¡')); const idxCat = headers.findIndex(h => h.includes('é¡åˆ¥')); const idxDesc = headers.findIndex(h => h.includes('æè¿°')); if (idxDate === -1 || idxAcc === -1 || idxAmt === -1) return alert(`åŒ¯å…¥å¤±æ•—ï¼šæ‰¾ä¸åˆ°é—œéµæ¬„ä½ã€‚\næˆ‘å€‘æŠ“åˆ°çš„æ¨™é¡Œï¼š${headers.join(', ')}\nè«‹ç¢ºä¿ CSV ç¬¬ä¸€åˆ—åŒ…å«ï¼šæ—¥æœŸ, å¸³æˆ¶, é‡‘é¡`); let successCount = 0; let skipCount = 0; for (let i = 1; i < rows.length; i++) { const rowText = rows[i].trim(); if (!rowText) continue; const cols = parseCSVLine(rowText); let dateStr = cols[idxDate]; const account = cols[idxAcc]; let type = idxType !== -1 ? cols[idxType] : 'æ”¯å‡º'; let amountStr = cols[idxAmt]; let category = idxCat !== -1 ? cols[idxCat] : ''; const desc = idxDesc !== -1 ? cols[idxDesc] : ''; if (!amountStr) continue; amountStr = amountStr.replace(/[$,\s]/g, ''); let amount = parseFloat(amountStr); dateStr = dateStr.replace(/\//g, '-'); if(dateStr.indexOf('-') > -1 && dateStr.length < 8) dateStr = '2025-' + dateStr; const dParts = dateStr.split('-'); if(dParts.length === 3) { if(dParts[1].length === 1) dParts[1] = '0' + dParts[1]; if(dParts[2].length === 1) dParts[2] = '0' + dParts[2]; dateStr = dParts.join('-'); } if (!dateStr || isNaN(amount) || !account) { skipCount++; continue; } if (type === 'æ”¯å‡º' && amount > 0) amount = -amount; if (type === 'æ”¶å…¥' && amount < 0) amount = Math.abs(amount); if (!appData.accounts.includes(account)) { appData.accounts.push(account); appData.accountColors[account] = '#868e96'; } if (type !== 'ä¸è¨ˆå…¥' && appData.categories[type] && category && !appData.categories[type].includes(category)) { appData.categories[type].push(category); } appData.transactions.push({ id: Date.now() + i, date: dateStr, account, type, amount, category, desc }); successCount++; } appData.transactions.sort((a, b) => b.date.localeCompare(a.date)); saveData(); alert(`æˆåŠŸåŒ¯å…¥ ${successCount} ç­†è³‡æ–™ï¼\n(è·³é ${skipCount} ç­†ç•°å¸¸è³‡æ–™)`); location.reload(); }; reader.readAsText(file, encoding); }
    function startEdit(id){ const tx=appData.transactions.find(t=>t.id==id); if(!tx)return; document.getElementById('dateInput').value=tx.date; document.getElementById('accountInput').value=tx.account; document.getElementById('typeInput').value=tx.type; handleTypeChange(); setTimeout(() => { if(tx.subAccount) document.getElementById('subAccountInput').value = tx.subAccount; }, 50); updateCategorySelect(); document.getElementById('categoryInput').value=tx.category; document.getElementById('amountInput').value=Math.abs(tx.amount); document.getElementById('descInput').value=tx.desc; editingId=id; document.getElementById('mainActionBtn').innerText='ğŸ’¾ å„²å­˜ä¿®æ”¹'; document.getElementById('mainActionBtn').classList.add('update-mode'); document.getElementById('cancelEditBtn').classList.remove('hidden'); document.querySelector('.container').scrollIntoView({behavior:'smooth'}); }
    function cancelEditMode(){ editingId=null; document.getElementById('amountInput').value=''; document.getElementById('descInput').value=''; document.getElementById('mainActionBtn').innerText='ï¼‹ æ–°å¢'; document.getElementById('mainActionBtn').classList.remove('update-mode'); document.getElementById('cancelEditBtn').classList.add('hidden'); document.getElementById('typeInput').value='æ”¯å‡º'; handleTypeChange(); }
    function deleteTx(id){ if(confirm('åˆªé™¤ï¼Ÿ')){ appData.transactions=appData.transactions.filter(t=>t.id!=id); if(editingId==id)cancelEditMode(); saveData(); initLogFilters(); renderTable(); calculateAndRenderBalance(); } }
    function renderDropdowns(){ const accs = appData.accounts.map(a=>`<option value="${a}">${a}</option>`).join(''); document.getElementById('accountInput').innerHTML=accs; document.getElementById('toAccountInput').innerHTML=accs; updateCategorySelect(); }
    function updateCategorySelect(){ const t=document.getElementById('typeInput').value; document.getElementById('categoryInput').innerHTML=(appData.categories[t]||[]).map(c=>`<option value="${c}">${c}</option>`).join(''); }
    function addAccount(){ const n=document.getElementById('newAccName').value.trim(), c=document.getElementById('newAccColor').value; if(n && !appData.accounts.includes(n)){ appData.accounts.push(n); appData.accountColors[n]=c; saveData(); renderSettings(); renderDropdowns(); document.getElementById('newAccName').value=''; } else { alert("åç¨±ç‚ºç©ºæˆ–å·²å­˜åœ¨"); } }
    function addCategory(){ const t=document.getElementById('catTypeSelect').value, n=document.getElementById('newCatName').value.trim(); if(n){ appData.categories[t].push(n); saveData(); renderSettings(); updateCategorySelect(); document.getElementById('newCatName').value=''; } }
    function renderSettings(){ renderSortableList('settingsAccList', appData.accounts, 'acc'); renderSortableList('settingsCatList', appData.categories[document.getElementById('catTypeSelect').value], 'cat'); }
    document.getElementById('catTypeSelect').addEventListener('change', renderSettings);
    function renderSortableList(id, list, type){ const ul=document.getElementById(id); ul.innerHTML=''; list.forEach((item,idx)=>{ const li=document.createElement('li'); li.className='sortable-item'; li.draggable=true; li.dataset.index=idx; if(editingItem && editingItem.type===type && editingItem.index===idx){ li.innerHTML=`<div class="edit-input-group"><input type="text" id="edit-input-${type}" value="${item}"><button class="save-btn" onclick="saveEdit('${type}',${idx},'${item}')">ğŸ’¾</button><button class="icon-btn" onclick="cancelEditItem()">âœ•</button></div>`; li.draggable=false; } else { let col = type==='acc'?`<span class="color-dot" style="background:${appData.accountColors[item]||'#ccc'}"></span>`:''; li.innerHTML=`<span class="drag-handle" style="padding-right:10px;color:#ccc;cursor:grab;">â‰¡</span><div style="flex-grow:1;display:flex;align-items:center;gap:10px;">${col}<span>${item}</span></div><div><button class="icon-btn edit-btn" onclick="startEditItem('${type}',${idx})">âœ</button><button class="icon-btn del-btn" onclick="removeItem('${type}',${idx},'${item}')">âœ•</button></div>`; } addDragEvents(li,type); ul.appendChild(li); }); }
    function startEditItem(type, idx){ editingItem={type,index:idx}; renderSettings(); setTimeout(()=>document.getElementById(`edit-input-${type}`).focus(),50); }
    function cancelEditItem(){ editingItem=null; renderSettings(); }
    function saveEdit(type, idx, oldVal){ const newVal=document.getElementById(`edit-input-${type}`).value.trim(); if(!newVal||newVal===oldVal){cancelEditItem();return;} if(type==='acc'){ appData.accounts[idx]=newVal; appData.accountColors[newVal]=appData.accountColors[oldVal]; delete appData.accountColors[oldVal]; appData.transactions.forEach(t=>{if(t.account===oldVal)t.account=newVal}); } else{ const t=document.getElementById('catTypeSelect').value; appData.categories[t][idx]=newVal; appData.transactions.forEach(tx=>{if(tx.category===oldVal&&tx.type===t)tx.category=newVal}); } editingItem=null; saveData(); renderSettings(); renderDropdowns(); renderTable(); calculateAndRenderBalance(); renderStats(); }
    function removeItem(type, idx, val){ if(!confirm(`ç¢ºå®šåˆªé™¤ "${val}"ï¼Ÿ`))return; if(type==='acc'){ appData.accounts.splice(idx,1); delete appData.accountColors[val]; } else{ appData.categories[document.getElementById('catTypeSelect').value].splice(idx,1); } saveData(); renderSettings(); renderDropdowns(); }
    let dragStart; function addDragEvents(li, type){ li.addEventListener('dragstart',()=>dragStart=+li.dataset.index); li.addEventListener('dragover',e=>e.preventDefault()); li.addEventListener('drop',()=>{ const end=+li.dataset.index; if(dragStart!==end){ if(type==='acc'){const i=appData.accounts.splice(dragStart,1)[0];appData.accounts.splice(end,0,i);}else{const list=appData.categories[document.getElementById('catTypeSelect').value];const i=list.splice(dragStart,1)[0];list.splice(end,0,i);} saveData(); renderSettings(); renderDropdowns(); } }); }
    function importData(input){ const r=new FileReader(); r.onload=e=>{appData=JSON.parse(e.target.result);saveData();location.reload();}; r.readAsText(input.files[0]); }
    function switchView(view) {
        ['log', 'balance', 'settings', 'stats'].forEach(v => {
            document.getElementById('view' + v.charAt(0).toUpperCase() + v.slice(1)).classList.add('hidden');
            document.getElementById('btn' + v.charAt(0).toUpperCase() + v.slice(1)).classList.remove('active');
        });
        document.getElementById('view' + view.charAt(0).toUpperCase() + view.slice(1)).classList.remove('hidden');
        document.getElementById('btn' + view.charAt(0).toUpperCase() + view.slice(1)).classList.add('active');
        if(view === 'balance') calculateAndRenderBalance();
        if(view === 'log') { initLogFilters(); renderTable(); }
        if(view === 'stats') renderStats();
    }
</script>

</body>
</html>